<head>
    <title>Import Apps</title>
    <meta charset="utf-8">
    <link href="../base1/patternfly.css" type="text/css" rel="stylesheet">
    <script src="../base1/jquery.js"></script>
    <script src="../base1/cockpit.js"></script>
    <script>
        var LEAPP_CONF = {};
    </script>
    <style>
        #ports ul li {
            font-size: 15px;
            margin-left: 50px;
            margin-top: 5px;
        }

        .border-top-dashed {
            border-top: 2px dashed #ddd;
        }

        .border-left-dashed {
            border-left: 2px dashed #ddd;
        }

        input[name=target-ports] {
            text-align: center;
            width: auto;
            display: inline
        }

        input[type=text].mapped-ports {
            margin-left: 10px;
            display: inline-block;
            width: auto;
        }

        label.source-ports {
             min-width: 11em
        }

        input[type=text].map-new-port-right {
            margin-left: 10px;
            margin-right: 1em;
        }

        form#map-new-port-form input[type=text]{
            display: inline;
            width: auto;
        }

        .source-port-font {
            font-weight: bold;
            color: #398fff;
            margin: 0 !important;
            display: inline-block;
            width:   40px;
        }

        .leapp ul {
            list-style-type: none;
        }

        #import-details h3 {
            text-align: center;
        }

        .invalid {
            background-color: #f66 !important;
        }

        .service-info {
            margin: 0 !important;
        }

        #import-details .section.col-sm-6:first-child {
            padding-right: 0px;
        }
        #import-details .section.col-sm-6:last-child {
            padding-left: 0px;
        }
        #import-details .section h3 {
            border: 1px solid #ddd;
            padding: .75em;
        }
        .spacer {
            margin: 30px;
        }
        .note {
            font-size: smaller;
            margin-top: 10px;
        }

        .leapp-progress h2 {
            margin: 0px;
            padding: 0px;
            display: block;
            text-align: center;
        }

        .leapp-progress #output {
            margin: -20px 20px 0 20px;
        }

        .leapp-progress #output div {
            font-weight: bolder;
        }

        .leapp .section {
            padding-bottom: 20px;
        }

        .import-info {
            margin-top: 20px;
            margin-bottom: 20px;
            padding-right: 0px;
        }

        .section.analyze h3 {
            text-align: center;
        }

        .checkbox {
            margin-top: 0px;
            margin-bottom: 0px;
        }

        #target-container-list {
            padding-top: 1em;
        }

        #target-container-list ul li {
            text-align: center;
        }

        input[type=checkbox] {
            margin-top: 6px;
        }


    </style>
</head>
<body>
    <div class="container-fluid leapp">
        <div style="padding: 1em;" class="row">
            <div class="col-sm-12" style="height: 30px;" >
                <div class="spinner spinner-lg" id="loader"></div>
            </div>
        </div>
        <div class="row section">
            <div class="col-sm-10">
                   <input id="source-address" type="text" class="form-control ui-lockable"
                          placeholder="Source IP or FQDN">
            </div>
            <div class="col-sm-2">
                <button id="scan-source-btn" class="btn btn-info form-control ui-lockable" type="button">Find apps
                </button>
            </div>
            <div class="col-sm-12">&nbsp;</div>
            <div class="col-md-10 col-sm-12">
                <div class="alert alert-info">
                  <span class="pficon pficon-info"></span>
                    SSH access for root must be enabled on the source machine. Upload a key to the users home folder
                    and unlock the key <a href="/#credentials-dialog" data-toggle="modal"
                    data-target="#credentials-dialog" class="alert-link" id="credentials-item">here</a>.
                    <strong>RSync has to be installed on the source machine.</strong>
                </div>
            </div>
        </div>
        <div id="analyze-stage" class="row section border-top-dashed analyze">
            <div class="col-md-6 col-sm-12">
                <h3>Externally visible TCP ports</h3>
                <div class="row">
                    <div class="col-sm-6">
                        <div id="mapped-ports">
                            <ul id="map-discovered">
                            </ul>
                        </div>
                        <div id="add-new-port">
                            <button class="btn btn-info ui-lockable" style="margin-left: 5em;" id="map-new-port-show">
                                Map new port
                            </button>
                            <ul id="map-new-port-add-form" class="hidden">
                                <li class="checkbox form-group">
                                    <form action="#" id="map-new-port-form">
                                        <label class="source-ports" id="map-new-port-src-form-group">
                                            Port
                                            <input type="text" size="6" name="add_port_src" id="add-port-src"
                                            class="ui-lockable form-control">
                                        </label>
                                        <span style="font-size: 2em;">&rarr;</span>

                                        <div style="display: inline" id="map-new-port-dst-form-group">
                                            <input type="text" size="6" name="add_port_dst" id="add-port-dst"
                                            class="map-new-port-right ui-lockable form-control" />
                                        </div>

                                        <input type="submit" id="confirm-add-port-btn" class="btn btn-primary
                                        ui-lockable" style="vertical-align: baseline !important" value="&#x2714;">

                                        <button id="cancel-add-port-btn" class="btn btn-default ui-lockable"
                                        style="vertical-align: baseline !important" type="button">
                                            &#x2716;
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div id="target-ports-field" class="col-sm-6">
                        <h4>Ports already in use:</h4>
                        <span></span>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-12">
                <!-- Application/Target container name... -->
                <h3>Application name</h3>
                <div class="col-sm-10 col-sm-offset-1">
                    <input id="application-name" type="text" class=" form-control ui-lockable">
                </div>
                <div id="target-container-list" style="display: none;" class="col-sm-12">
                    <h4 class="text-center">Application names already in use:</h4>
                    <ul>
                        <li></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="row section border-top-dashed analyze">
            <div class="import-info col-xs-12">
                <div class="col-xs-12">
                    <span class="pull-right">
                        The application will be put into a container and run on this machine.
                    </span>
                </div>
                <div class="col-xs-12">
                    <span class="pull-right">The orignal application will stay intact.</span>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="pull-right">
                    <div class="text-center">
                        <button translatable="yes" class="col-xs-12 btn btn-default btn-primary btn-lg ui-lockable pull-right"
                                id="import-button" disabled>Import</button>
                        <div class="checkbox col-xs-12">
                            <label data-toggle="tooltip" data-placement="bottom"
                                   title="If checked, any existing container of the same name will be replaced by this
                                          application.">
                                <input type="checkbox" id="force-creation" class="ui-lockable" checked>
                                Force creation
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row section">
            <div class="col-sm-12">
                <pre class="leapp-progress" style="display: none;">
                    <h2>Progress</h2>
                    <div id="output"></div>
                </pre>
            </div>
        </div>
        <div>
            <center id="leapp-version"></center>
        </div>
    </div>

    <script>
        const MIN_PORT = 1;
        const MAX_PORT = 65535;

        var target_ports = [];

        var AGENT_AUTH_SOCK='';
        cockpit.spawn(['/bin/bash', '-c', 'echo $SSH_AUTH_SOCK']).done(function(e){
            AGENT_AUTH_SOCK = (e || '').trim();
        });

        $(function () {
          $('.analyze').hide();
          $('[data-toggle="tooltip"]').tooltip()
        });

        // Handle enter key press in the ip/fqdn field and submit
        $("#source-address").keypress(function(e) {
            if (e.which == 13) {
                $("#scan-source-btn").click();
            }
        });

        $("#scan-source-btn").click(function(){
            get_target_ports();
            $(".analyze").fadeIn();
        });

        $("#map-new-port-show").click(function(){
            $("#map-new-port-form").find("input[type=text]").val("")
            $("#map-new-port-form").find("input[type=text]").parent().removeClass("has-error")

            $(this).addClass("hidden")
            $("#map-new-port-add-form").removeClass("hidden")

            $("#add-port-src").focus()
        });

        $("#map-new-port-form").submit(function(event){
            event.preventDefault()
            $("#map-new-port-form").find("input[type=text]").parent().removeClass("has-error")

            src_element = $("#add-port-src")
            tgt_element = $("#add-port-dst")

            source_port = parseInt(src_element.val())
            target_port = parseInt(tgt_element.val())

            if(isNaN(source_port) || isNaN(target_port)){
                //show error
                var field
                var msg

                if(isNaN(source_port)){
                    field = $("#map-new-port-src-form-group")
                    msg = "Invalid source port"
                }
                else if(isNaN(target_port)){
                    field = $("#map-new-port-dst-form-group")
                    msg = "Invalid target port"
                }

                field.addClass("has-error") 
                field.find("input").first().focus()

                //showError(msg)
                console.log(msg)
            }
            else {
                var element = add_port_entry(source_port, target_port)
                $(element).children("input.mapped-ports").trigger("change");

                $("#map-new-port-show").removeClass("hidden")
                $("#map-new-port-add-form").addClass("hidden")
                release_lock_cmd()
            }
        });

        $("#cancel-add-port-btn").click(function(){
            $("#map-new-port-show").removeClass("hidden")
            $("#map-new-port-add-form").addClass("hidden")
        });

        var output = $("#output");
        var loader = $("#loader");
        loader.hide();
        // flag to show "wait for result" message after command exc - must be removed after summit !
        var wait_for_result_msg = false;

        $("#import-button").on("click", import_to_host);

        $(document).ready(function() {
            // First load the configuration and then start running all other tasks
            $.ajax({
                dataType: "json",
                url: "./config.json",
                success: function(data){
                    LEAPP_CONF = data;
                },
            }).then(function() {
                $("#leapp-version").text("Le-App - " + LEAPP_CONF["version"]);
            });
        });

        function set_lock_cmd() {
            $(".ui-lockable").attr("disabled", true);
        }

        function release_lock_cmd() {
            $(".ui-lockable").removeAttr("disabled");
        }

        function out(line, is_command) {
            $(".leapp-progress").fadeIn();
            var stamp = (new Date()).toISOString();
            var style = '';
            if (is_command === true) {
                style += 'color: #000;';
            }
            output.append(`<div>${stamp} - <span style="${style}">${line}</span></div>`);
        }

        function call_leapp(cmd_args) {
            set_lock_cmd();
            var cmd_line = [LEAPP_CONF["tool-path"]].concat(cmd_args);
            out(cmd_line.join(' '), true);
            return cockpit.spawn(
                cmd_line,
                {
                    "directory": LEAPP_CONF["tool-workdir"],
                    "environ": ["SSH_AUTH_SOCK=" + AGENT_AUTH_SOCK],
                    "superuser": "required",
                    "err": "out",
                }
            );
        }

        function add_mapping_handler(element) {
            $(element).on('change', function() {
                var changed = $(this);
                var new_port = parseInt(changed.val(), 10);
                var dups = $('input.mapped-ports').filter(function(){
                    return $(this).attr('id') != changed.attr('id') && $(this).val() == changed.val();
                });

                var valid = Number.isInteger(new_port)
                    && target_ports.indexOf(changed.val()) == -1
                    && new_port >= MIN_PORT
                    && new_port <= MAX_PORT
                    && dups.length == 0
                ;

                if (!valid) {
                    $("#import-button").attr("disabled", true);
                    dups.parent("li").addClass("has-error");
                    changed.parent("li").addClass("has-error");
                } else {
                    $(this).parent("li").removeClass("has-error");
                    $("li.has-error input.mapped-ports").trigger("change");
                }

                if ($("#mapped-ports ul li.has-error").length === 0) {
                    $("#import-button").removeAttr("disabled");
                }
            });
        }

        function add_port_entry(source_port, mapped_port, has_tooltip=false) {
            var tooltip_content = "";
            if (has_tooltip) {
                tooltip_content = `data-toggle="tooltip" data-placement="bottom" title="loading..."`;
            }
            var element = $(`
                <li class="checkbox">
                    <label class="source-ports">
                        <input type="checkbox" data-target="#mapped-port-${source_port}" checked>
                        Port
                        <span class="source-port-font mapped-port-info" ${tooltip_content} data-port="${source_port}">
                            ${source_port}
                        </span>
                    </label>
                    <span style="font-size: 2em;">&rarr;</span>
                    <input type="text" size="6" id="mapped-port-${source_port}" value="${mapped_port}"
                           data-source="${source_port}" class="form-control mapped-ports ui-lockable"/>
                </li>
            `);
            $("#mapped-ports ul").append(element);
            add_mapping_handler(element.children("input.mapped-ports"));
            return element;
        }

        function get_port_mapping() {
            out("Loading default port mapping....");
            var proc = call_leapp(override_identity([
                'migrate-machine', '-p', '--use-rsync', '-t', '127.0.0.1', $("#source-address").val()]));
            proc.done(function(data){
                cmd_success(data, true);
                var mapping = JSON.parse(data);
                var source_ports = [];
                $("#mapped-ports ul li").remove();
                mapping.forEach(function(entry) {
                    var mapped_port = entry[0];
                    var source_port = entry[1];
                    source_ports.push(source_port);
                    add_port_entry(source_port, mapped_port, true);
                });
                $('.mapped-port-info').tooltip();
                scan_ports($("#source-address").val(), add_ports_product_info, source_ports, false);
            });
            proc.fail(cmd_fail);
        }

        function set_app_list(args) {
            cmd_success(args);
            $("#target-container-list ul li").remove();
            $("#target-container-list").hide();
            var containers = args.split('\n');
            containers.forEach(function(e) {
                $("#target-container-list ul").append(`<li>${e}</li>`);
            });
            if (containers.length > 0) {
                $("#target-container-list").fadeIn();
            }
            get_port_mapping();
        }

        function load_target_container_names() {
            var proc = call_leapp(["check-target", "127.0.0.1"]);
            proc.done(set_app_list);
            proc.fail(cmd_fail);
        }

        function override_identity(cmd_args) {
            // Appends any defined identity override settings to a command
            if ("override-username" in LEAPP_CONF) {
                cmd_args.push("--target-user", LEAPP_CONF["override-username"])
                cmd_args.push("--source-user", LEAPP_CONF["override-username"])
            }
            return cmd_args;
        }

        function import_to_host(event) {
            wait_for_result_msg = true;

            var source = $("#source-address").val();
            var target = "127.0.0.1";

            var mapped_ports = [];
            $("#mapped-ports ul li label input[type=checkbox]:checked").each(function(i, element) {
                var target = $($(element).data("target"));
                if (target.val()) {
                    mapped_ports.push(target.val() + ":" + target.data("source"));
                }
            });

            var import_args = ["migrate-machine"]
            import_args.push("--use-rsync");
            override_identity(import_args);
            import_args.push("--tcp-port");
            Array.prototype.push.apply(import_args, mapped_ports)
            import_args.push("-t", target, source)

            if ($("#application-name").val()) {
                import_args.push("--container-name", $("#application-name").val());
            }
            if ($("#force-creation")[0].checked) {
                import_args.push("--force-create");
            }

            //output.empty();
            var proc = call_leapp(import_args);

            proc.done(cmd_success);
            proc.fail(cmd_fail);
            proc.stream(cmd_stdout);

            out(`Migrating ${source} to ${target}`);
            out(`This can take a while, do not close this page ... `);
            loader.show();
        }

        function scan_ports(ip_addr, callback, ports=null, shallow=false) {

            var scan_args = ['port-inspect', ip_addr];
            if (ports !== null) {
                scan_args.push('--range', ports);
            }
            if (shallow) {
                scan_args.push('--shallow');
            }
            //output.empty();
            var proc = call_leapp(scan_args);
            proc.done(callback);
            proc.fail(cmd_fail);

            out(`Scanning ports on ${ip_addr}`);
            loader.show();
        }

        function add_ports_product_info(data) {
            cmd_success(data, true);
            data = JSON.parse(data);
            if (typeof(data.ports.tcp) !== undefined) {
                $('.mapped-port-info').each(function(i,e) {
                    var p = $(e).data('port');
                    if (p in data.ports.tcp) {
                        $(e).attr('data-original-title',
                                  `Port ${p} is used by ${data.ports.tcp[p].product || data.ports.tcp[p].name}`);
                        $(e).tooltip('fixTitle');
                    }
                });
            }
        }

        function get_target_ports() {
            scan_ports("127.0.0.1", show_target_ports, null, true);  // scan target machine
        }

        function show_target_ports(data) {
            cmd_success(data, true);
            var data = JSON.parse(data);
            target_ports = [];
            if (typeof(data.ports.tcp) !== undefined) {
                for (port in data.ports.tcp) {
                    target_ports.push(port);
                }
                $("#target-ports-field span").text(target_ports.join(", "));
            }
            load_target_container_names();
        }

        function cmd_stdout(data) {
            let split = data.split(/\r?\n/);
            for (let line of split) {
                if (line) {
                    out("> " + line)
                }
            }
        }

        function cmd_success(data, no_data=false) {
            if (no_data !== true) {
                cmd_stdout(data);
            }
            out("Command completed successfully");
            if (wait_for_result_msg) {
                out("\n\nImported service is now starting, please wait about 2 minutes to see results..");
            }
            loader.hide();

            release_lock_cmd();
            wait_for_result_msg = false;
        }

        function cmd_fail(exc, data) {
            //output.empty();
            cmd_stdout(data || '');
            err_msg = `Command failed with status ${exc.exit_status}!\n`
            out(err_msg);
            loader.hide();
            release_lock_cmd();
        }

    </script>
</body>
</html>
